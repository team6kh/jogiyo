<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sqlMap PUBLIC '-//ibatis.apache.org//DTD Sql Map 2.0//EN' 'http://ibatis.apache.org/dtd/sql-map-2.dtd'>


<sqlMap namespace="Paid">
	<typeAlias alias="paidDTO" type="board.paid.dto.PaidDTO"/>
	<typeAlias alias="menuDTO" type="board.paid.dto.MenuDTO"/>
	<typeAlias alias="searchConditionDTO" type="board.paid.dto.SearchConditionDTO"/>
	<typeAlias alias="cooponDTO" type="table.coopon.dto.CooponDTO" />
	<typeAlias alias="cartDTO" type="board.cart.dto.CartDTO" />
      
      <resultMap class="paidDTO" id="paidRes">
		<result property="paid_num" column="paid_num" />
		<result property="paid_rest_num" column="paid_rest_num" />
		<result property="paid_rest_subject" column="paid_rest_subject" />
		<result property="paid_restopt_num" column="paid_restopt_num" />
		<result property="paid_restopt_subject" column="paid_restopt_subject" />
		<result property="paid_restopt_priceplus" column="paid_restopt_priceplus" />
		<result property="paid_restopt_destFile1" column="paid_restopt_destFile1" />
		<result property="paid_cpn" column="paid_cpn" />
		<result property="paid_cpn_used" column="paid_cpn_used" />
		<result property="session_id" column="session_id" />
		<result property="paid_reg_date" column="paid_reg_date" />
	</resultMap>
      
      <resultMap class="cooponDTO" id="cooponRes">
		<result property="cpn_num" column="cpn_num" />
	</resultMap>
      
      <resultMap class="menuDTO" id="menuRes">	     
	      <result property="paid_restopt_subject" column="paid_restopt_subject"/>
	      <result property="paid_sales_volume" column="paid_sales_volume"/>
	      <result property="paid_sales_price" column="paid_sales_price"/>
      </resultMap>
      
      

	<!-- 공통정의 -->
	<sql id="fromRPBoard">
		from rest_board r,paid_board p
	</sql>
	<sql id="whereRest">
    	where rest_writer_id = #session_id# and rest_num=paid_rest_num
    </sql>
    
    <sql id="paidDate">
        (paid_reg_date BETWEEN TO_DATE(#startDate#, 'yyyy-MM-dd') AND TO_DATE(#endDate#, 'yyyy-MM-dd')+0.99999) 
    </sql>
    
    
    
    <!-- select -->
    <select id="paidList" resultMap="paidRes" parameterClass="searchDTO">
        SELECT 
			        	p.paid_num,
                        p.paid_rest_num,     
			        	p.paid_rest_subject,
			        	p.paid_restopt_subject,
			        	p.paid_restopt_priceplus,
                        p.paid_cpn,
                        p.paid_cpn_used,
			        	p.session_id,
			        	p.paid_reg_date 
        <include refid="fromRPBoard"/> 
        <include refid="whereRest"/> AND <include refid="paidDate"/>
        ORDER BY paid_reg_date DESC  	
    </select>
    
   <select id="hotmenu" resultMap="menuRes" parameterClass="searchDTO">          
        SELECT * FROM
  				(SELECT 
								paid_restopt_subject, 
								count(*) as paid_sales_volume, 
								sum(paid_restopt_priceplus) as paid_sales_price, 
								rownum as paid_rownum
  										
   				FROM 	paid_board 	
   				WHERE 	paid_rest_num = #rest_num# AND <include refid="paidDate"/> 
   				GROUP BY  paid_restopt_subject, rownum 
   				ORDER BY paid_sales_volume DESC) 

        WHERE  paid_rownum <![CDATA[>=]]> 1  AND paid_rownum <![CDATA[<=]]> 5
   </select>
   
   <!-- 쿠폰 사용 요청(paid_board에서 PAID_CPN_USED = 1인 레코드) 내역 추출 -->
   <select id="responseCPN" resultMap="paidRes" parameterClass="searchDTO">
        SELECT        
                        p.paid_num,
                        p.paid_rest_num, 
                        p.paid_restopt_subject,
                        p.paid_restopt_priceplus,
                        p.paid_cpn,
                        p.paid_cpn_used,
                        p.session_id,
                        p.paid_reg_date 
        <include refid="fromRPBoard"/>
        <include refid="whereRest"/> AND p.paid_cpn_used = 1 
        ORDER BY paid_reg_date
   </select>
   
   <!-- select -->
	<select id="selectCheckcpn" resultClass="int" parameterClass="java.lang.String">
		select count(*) from coopon_table where cpn_num = #cpn_num#
	</select>

	<select id="selectPaidLastNo" resultClass="PaidDTO" parameterClass="int">
		SELECT max(paid_num) as paid_num FROM paid_board
	</select>

	<select id="selectPaidCount" resultClass="int">
		SELECT count(*) FROM paid_board
	</select>
	
	<select id="selectPaidnow" resultMap="PaidBoard" parameterClass="PaidDTO">
		select * from paid_board where paid_num > #paid_num#
	</select>
	
	<select id="selectPaidAll" resultMap="PaidBoard" parameterClass="CartDTO">
		select * from paid_board
		where paid_rest_num=#cart_rest_num# and session_id=#session_id#
	</select>
	
	<select id="myListCoupon" resultMap="PaidBoard" parameterClass="java.lang.String">
		SELECT * FROM PAID_BOARD WHERE session_id = #session_id# ORDER BY paid_num DESC
	</select>
	
	<select id="myListTime" resultMap="PaidBoard" parameterClass="board.paid.dto.SearchConditionDTO">
		SELECT * FROM PAID_BOARD 
		WHERE SESSION_ID = #session_id# 
		AND (PAID_REG_DATE Between to_date(#startDate#, 'yyyy-MM-dd') AND to_date(#endDate#, 'yyyy-MM-dd')
 		+0.99999)	ORDER BY paid_num DESC
	</select>
   
	<select id="selectCheckcpn" resultClass="int" parameterClass="java.lang.String">
		select count(*) from coopon_table where cpn_num = #cpn_num#
	</select>

	<select id="selectPaidLastNo" resultClass="paidDTO" parameterClass="int">
		SELECT max(paid_num) as paid_num FROM paid_board
	</select>

	<select id="selectPaidCount" resultClass="int">
		SELECT count(*) FROM paid_board
	</select>

	<select id="selectPaidnow" resultMap="paidRes" parameterClass="paidDTO">
		select * from paid_board where paid_num > #paid_num#
	</select>
	
	<select id="selectPaidAll" resultMap="paidRes" parameterClass="cartDTO">
		select * from paid_board
		where paid_rest_num=#cart_rest_num# and session_id=#session_id#
	</select>

	<select id="myListCoupon" resultMap="paidRes" parameterClass="java.lang.String">
		SELECT * FROM PAID_BOARD WHERE session_id = #session_id# ORDER BY paid_num DESC
	</select>
	
	<select id="myListTime" resultMap="paidRes" parameterClass="searchConditionDTO">
		SELECT * FROM PAID_BOARD 
		WHERE SESSION_ID = #session_id# 
		AND (PAID_REG_DATE Between to_date(#startDate#, 'yyyy-MM-dd') AND to_date(#endDate#, 'yyyy-MM-dd')
 		+0.99999)	ORDER BY paid_num DESC
	</select>
   
   
   <!-- insert -->
	<insert id="insertCpn" parameterClass="cooponDTO">
		Insert into coopon_table (cpn_num) values (#cpn_num#)
	</insert>
	
	<insert id="insertPaidBoard" parameterClass="paidDTO">
		Insert into paid_board (paid_num, paid_rest_num, paid_rest_subject, paid_restopt_num, paid_restopt_subject, paid_restopt_priceplus, paid_restopt_destFile1, paid_cpn, paid_cpn_used, session_id, paid_reg_date) values (paid_seq_num.NEXTVAL, #paid_rest_num#, #paid_rest_subject#, #paid_restopt_num#, #paid_restopt_subject#, #paid_restopt_priceplus#, #paid_restopt_destFile1#, #paid_cpn#, #paid_cpn_used#, #session_id#, #paid_reg_date#)
	</insert>
   
   
   <!-- update -->
   <update id="submitCPN" parameterClass="int">
        UPDATE paid_board
        SET paid_cpn_used = 2    
        WHERE paid_num = #paid_num#
    </update>
    
    <update id="requestCPN" parameterClass="int">
		UPDATE paid_board SET paid_cpn_used = 1
		where paid_num = #paid_num#
	</update>
    
    
</sqlMap>